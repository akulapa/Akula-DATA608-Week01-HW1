---
title: "DATA608 Week01-Assignment"
author: "Pavan Akula"
date: "February 4, 2018"
output:
  html_document: default
  html_notebook: default
---

**Principles of Data Visualization and Introduction to ggplot2**

I have provided you with data about the 5,000 fastest growing companies in the US, as compiled by Inc. magazine. lets read this in:

```{r, echo=T, warning=F, message=F}
library(dplyr)    # subseting, changing data layout
library(ggplot2)  # graphs generation
library(knitr)    # Report display, table format
library(kableExtra)

#Load data
inc <- read.csv("https://raw.githubusercontent.com/charleyferrari/CUNY_DATA_608/master/module1/Data/inc5000_data.csv", header= TRUE, stringsAsFactors = F)

```

And lets preview this data:

```{r}

head(inc)

```
```{r}

summary(inc)

```

Think a bit on what these summaries mean. Use the space below to add some more relevant non-visual exploratory information you think helps you understand this data:

####Summary 

Minimum employees per company is `one`, average is `233` and maximum is `66803`. Values are for entire dataset.

Revenues also, summary is for entire dataset. Minmum revenues generated by a company is \$200,000, average is \$4,822,000 and maximum is \$1,010,000,000 

```{r}

# Insert your code here, create more chunks as necessary

```

## Question 1

Create a graph that shows the distribution of companies in the dataset by State (ie how many are in each state). There are a lot of States, so consider which axis you should use. This visualization is ultimately going to be consumed on a 'portrait' oriented screen (ie taller than wide), which should further guide your layout choices.

```{r}

# Answer Question 1 here
# Calculate companies count
state.company <- inc %>%
  group_by(State) %>% 
  summarise(companiesCount = n()) %>%
  select (State,companiesCount)

#Display data
state.company %>% 
  kable(format="html", caption = "Companies Count by State") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left")

#Generate the graph
ggplot(state.company, aes(x=State, y=companiesCount)) +
  geom_bar(width=.5,stat="identity",position = "dodge") +
  theme(text=element_text(size=8)) +
  ggtitle("Distribution of Companies By State") +
  xlab("State") + ylab("Companies Count") +
  coord_flip()

```

According to graph `California` has most companies. Followed by `Texas` and `New York`.

## Quesiton 2

Lets dig in on the state with the 3rd most companies in the data set. Imagine you work for the state and are interested in how many people are employed by companies in different industries. Create a plot that shows the average and/or median employment by industry for companies in this state (only use cases with full data, use R's `complete.cases()` function.) In addition to this, your graph should show how variable the ranges are, and you should deal with outliers.

I have used two methods to answer the question, the first method uses average employment per industry to remove outliers that fall outside $\pm\ 2\ Standard deviations$ per industry. Second method calculates the average and standard deviation across all industries in the state and removes outliers. Both methods skew the results because outliers have a higher impact on output.

Example: Company `Sutherland Global Services` in `Business Products & Services` employs `32000` people and company `TransPerfect` employs `2218` people. Rest all companies combined in `Business Products & Services` provide employment to `4586` people. This distribution impacts average and standard deviation.

Average employment in `Business Products & Services` without companies `Sutherland Global Services` and `TransPerfect` is `191`, in the presence of both companies number jumps to `1493`. This explains outlier impact.

On the graph both methods display $95\%$ of data.

####Method 1

```{r}
# Answer Question 2 here

#Remove rows with NA values using complete.cases()
inc <- inc[complete.cases(inc),]

#Get companies per state
state.company <- inc %>%
  group_by(State) %>% 
  summarise(companiesCount = n()) %>%
  select (State,companiesCount)

#Get third state with most companies
third.state <- state.company %>% 
  arrange(desc(companiesCount)) %>% 
  top_n(3) %>% 
  filter(companiesCount == min(companiesCount)) %>% 
  inner_join(inc, by = c("State" = "State")) %>%
  select (Name, Industry, Revenue, Employees, State)

#Get the state
state <- unique(third.state$State)

#Get mean and standard deviation
third.state.summary <- third.state %>% 
        group_by(Industry) %>% 
        summarise(Employees.avg = mean(Employees), Employees.sd = sd(Employees), Employees.sum = sum(Employees), Company.Count = n())

third.state.summary <- replace(third.state.summary, is.na(third.state.summary), 0)

#Calculate upper bound and lower bound
third.state.summary$lbound <- third.state.summary$Employees.avg - 2*third.state.summary$Employees.sd
third.state.summary$ubound <- third.state.summary$Employees.avg + 2*third.state.summary$Employees.sd

#Eliminate outliers that do not fall with in 2 standard deviations
third.state.data <- third.state %>% 
  inner_join(third.state.summary, by = c("Industry" = "Industry")) %>%
  filter(Employees >= lbound) %>%
  filter(Employees <= ubound) %>% 
  select (Name, Industry, Employees, Revenue, Employees.avg, Employees.sd)

#Display data
third.state.summary %>% 
  kable(format='pandoc', caption = "Employment Summary by Industry - With Outliers", digits=2)

#Generate the plot without outliers
ggplot(third.state.data, aes(x = Industry, y = Employees)) +
  geom_bar(stat = "identity") + coord_flip() + ggtitle(paste("Average Employees per Industry In",state,"State -")) + 
  labs(subtitle = "Using Average by Industry - Without Outliers")

```

According to the graph `Business Products & Services` industry employs most people. Followed by `IT Services`, when the graph is generated using employment average of each industry without outliers. The graph shows $95\%$ of the data.

####Method 2

```{r}
#Get mean and standard deviation
state.avg = mean(third.state$Employees)
state.sd = sd(third.state$Employees)

lbound = state.avg - (2 * state.sd)
ubound = state.avg + (2 * state.sd)

#Eliminate outliers that do not fall with in 2 standard deviations
third.state.data <- third.state %>% 
  filter(Employees >= lbound) %>%
  filter(Employees <= ubound) %>% 
  select (Name, Industry, Employees, Revenue)

#Generate the plot without outliers
ggplot(third.state.data, aes(x = Industry, y = Employees)) +
  geom_bar(stat = "identity") + coord_flip() + ggtitle(paste("Average Employees per Industry In",state,"State"))  + labs(subtitle = "Using Average Employment of the State - Without Outliers")

```

According to the graph `IT Services` industry employs most people. Followed by `Business Products & Services`, when the graph is generated using employment average across the state without outliers. The graph shows $95\%$ of the data.

## Question 3

Now imagine you work for an investor and want to see which industries generate the most revenue per employee. Create a chart that makes this information clear. Once again, the distribution per industry should be shown.

```{r}
# Answer Question 3 here
#Revenues generated per employee
third.state.revenue <- third.state.data %>% 
  group_by(Industry) %>% 
  summarise(Revenue = sum(Revenue)/sum(Employees))

#Generate the plot
ggplot(third.state.revenue, aes(x = Industry, y = Revenue)) +
  geom_bar(stat = "identity") + scale_y_continuous(labels = scales::comma) + coord_flip() + ggtitle(paste("Average Revenue per Employee per Industry In",state,"State"))

```

According to the graph `Energy` industry generates highest revenues per employee. Followed by `Logistics & Transportation`. 

####References

- https://stackoverflow.com/questions/28687515/search-for-and-remove-outliers-from-a-dataframe-grouped-by-a-variable
- https://www.youtube.com/watch?v=EXhUb80Kfrg


